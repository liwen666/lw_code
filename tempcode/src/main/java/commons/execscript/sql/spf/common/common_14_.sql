CREATE OR REPLACE PROCEDURE SYS_P_KEEP_ACCOUNTS(P_WHERE VARCHAR2) IS
    V_TABLEID VARCHAR2(32);
    V_TABLE VARCHAR2(30);
    V_SQL VARCHAR2(32760);
    V_TMP VARCHAR2(4000);
    V_COLLIST VARCHAR2(4000);
    V_EXP VARCHAR2(4000);
  BEGIN
    SELECT TABLEID,DBTABLENAME INTO V_TABLEID,V_TABLE FROM DICT_T_MODEL WHERE DEALTYPE = '2101';
    V_TMP := ' ';
    V_EXP := ' 
   CASE FUNDSOURCEGUID 
     ';
    FOR C_DATA IN (SELECT X.FUNDSOURCENAME, Y.TOBASECOL, X.CODE, X.FUNDSOURCEID,Y.VALUERATIO
          FROM BGT_V_PUBFUNDSOURCE X, EXP_S_PROJINVEST Y, DICT_T_FACTOR Z
         WHERE X.FUNDSOURCEID = Y.FUNDSOURCEID
           AND Y.TOBASECOL = Z.DBCOLUMNNAME
           AND Z.TABLEID = V_TABLEID
           AND Z.ISLEAF = '1') LOOP
       V_TMP :=V_TMP||C_DATA.TOBASECOL||' AS '''||C_DATA.FUNDSOURCEID||''',';
       V_EXP := V_EXP||'WHEN '''||C_DATA.FUNDSOURCEID||''' THEN '||TO_CHAR(C_DATA.VALUERATIO)||'
     ';
    END LOOP;
    V_EXP := V_EXP||
    ' ELSE 10000 
   END';
    V_TMP := SUBSTR(V_TMP,1,LENGTH(V_TMP) - 1);
    SELECT CONNSTRA(COLUMN_NAME||',') INTO V_COLLIST FROM USER_TAB_COLUMNS
    WHERE TABLE_NAME = 'BGT_T_YSJZSJB' AND COLUMN_NAME NOT IN ('GUID','AMT','SFJZ','ISWRITEOFF');
    V_COLLIST := SUBSTR(V_COLLIST,1,LENGTH(V_COLLIST) - 1);
    --存在的数据更新
    --对于已经存在的数据，没有记账 SFJZ = '0' 的直接更新，已经记账SFJZ= '1' 且 是否冲抵ISWRITEOFF ='0'的数据复制一行金额为负数的行，两行数据 是否冲抵 都变为'1'，再插入一行
    V_SQL := 'UPDATE BGT_T_YSJZSJB TA
    SET TA.AMT = (SELECT TB.AMT FROM '||Q'{(
    SELECT Y.FINYEAR,Y.AGENCYID AGENCYGUID,Y.SPFID PROGUID,'01687gDiFwDjc' AGENCYEXPGUID, '' EXPFUNCGUID,'01687E2hS1Edv' FUNDTYPEGUID,Y.EXPECOGUID,Y.FUNDSOURCEGUID,Y.AMT}'||' * '||V_EXP||Q'{ AMT,Y.DATAKEY,Y.DBVERSION
    FROM (
    SELECT FINYEAR,DATAKEY,AGENCYID,SPFID, EXPECOID EXPECOGUID, FUNDSOURCEGUID, AMT,DBVERSION  FROM (
    SELECT * FROM }'||V_TABLE|| ' T1
    WHERE (EXPECOID IS NOT NULL OR EXPFUNCID IS NOT NULL) AND PROJECTID <> ''*'' AND SPFID IN (SELECT TASKID FROM SPF_T_OARELATION WHERE DOCID = '''||P_WHERE||''' AND TASKTYPE = ''0'') AND NOT EXISTS(SELECT 1 FROM BGT_T_YSLYWHB WHERE SUPERID = T1.DATAKEY)
    ) TT
    UNPIVOT(AMT FOR FUNDSOURCEGUID IN('||V_TMP||Q'{))) Y) TB
    WHERE (TA.FINYEAR = TB.FINYEAR AND TA.PROGUID = TB.PROGUID AND TA.AGENCYGUID = TB.AGENCYGUID AND TA.EXPECOGUID = TB.EXPECOGUID AND TA.FUNDSOURCEGUID = TB.FUNDSOURCEGUID))
  WHERE TA.SFJZ = '0' AND TA.ISWRITEOFF = '0' AND EXISTS(SELECT 1 FROM }'||Q'{(SELECT Y.FINYEAR,Y.AGENCYID AGENCYGUID,Y.SPFID PROGUID,'01687gDiFwDjc' AGENCYEXPGUID, '' EXPFUNCGUID,'01687E2hS1Edv' FUNDTYPEGUID,Y.EXPECOGUID,Y.FUNDSOURCEGUID,Y.AMT,Y.DATAKEY,Y.DBVERSION
   FROM (
   SELECT FINYEAR,DATAKEY,AGENCYID,SPFID, EXPECOID EXPECOGUID, FUNDSOURCEGUID, AMT,DBVERSION  FROM (
   SELECT * FROM }'||V_TABLE|| ' T1
   WHERE (EXPECOID IS NOT NULL OR EXPFUNCID IS NOT NULL) AND PROJECTID = ''*'' AND SPFID IN (SELECT TASKID FROM SPF_T_OARELATION WHERE DOCID = '''||P_WHERE||''' AND TASKTYPE = ''0'') AND  NOT EXISTS(SELECT 1 FROM BGT_T_YSLYWHB WHERE SUPERID = T1.DATAKEY)
   ) TT
   UNPIVOT(AMT FOR FUNDSOURCEGUID IN('||V_TMP||'))) Y) TB
   WHERE (TA.FINYEAR = TB.FINYEAR AND TA.PROGUID = TB.PROGUID AND TA.AGENCYGUID = TB.AGENCYGUID AND TA.EXPECOGUID = TB.EXPECOGUID AND TA.FUNDSOURCEGUID = TB.FUNDSOURCEGUID))';
   BEGIN
      EXECUTE IMMEDIATE V_SQL;
    EXCEPTION WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      RAISE;
    END;

    --对于已经存在的数据，已经记账SFJZ= '1' 且 是否冲抵ISWRITEOFF ='0'的数据复制一行金额为负数的行，两行数据 是否冲抵 ISWRITEOFF都变为'1'，再插入一行
    V_SQL := Q'{BEGIN
  FOR C_DATA IN (
  SELECT FINYEAR,PROGUID,AGENCYGUID,EXPECOGUID,FUNDSOURCEGUID,SFJZ,ISWRITEOFF FROM BGT_T_YSJZSJB TA WHERE TA.SFJZ = '1'  AND TA.ISWRITEOFF ='0'
  AND EXISTS (SELECT 1 FROM (SELECT Y.FINYEAR,Y.AGENCYID AGENCYGUID,Y.SPFID PROGUID,'01687gDiFwDjc' AGENCYEXPGUID, '' EXPFUNCGUID,'01687E2hS1Edv' FUNDTYPEGUID,Y.EXPECOGUID,Y.FUNDSOURCEGUID,Y.AMT,Y.DATAKEY,Y.DBVERSION
     FROM (
     SELECT FINYEAR,DATAKEY,AGENCYID,SPFID, EXPECOID EXPECOGUID, FUNDSOURCEGUID, AMT,DBVERSION  FROM (
     SELECT * FROM }'||V_TABLE|| ' T1
     WHERE (EXPECOID IS NOT NULL OR EXPFUNCID IS NOT NULL) AND PROJECTID = ''*'' AND SPFID IN (SELECT TASKID FROM SPF_T_OARELATION WHERE DOCID = '''||P_WHERE||''' AND TASKTYPE = ''0'') AND NOT EXISTS(SELECT 1 FROM BGT_T_YSLYWHB WHERE SUPERID = T1.DATAKEY)
     ) TT
     UNPIVOT(AMT FOR FUNDSOURCEGUID IN('||V_TMP||'))) Y) TB
     WHERE (TA.FINYEAR = TB.FINYEAR AND TA.PROGUID = TB.PROGUID AND TA.AGENCYGUID = TB.AGENCYGUID AND TA.EXPECOGUID = TB.EXPECOGUID AND TA.FUNDSOURCEGUID = TB.FUNDSOURCEGUID))) LOOP

     INSERT INTO BGT_T_YSJZSJB('||V_COLLIST||',AMT,SFJZ,ISWRITEOFF)
     SELECT '||V_COLLIST||Q'{,0-AMT AMT,'0' SFJZ,'1' ISWRITEOFF
     FROM BGT_T_YSJZSJB
     WHERE FINYEAR = C_DATA.FINYEAR AND PROGUID = C_DATA.PROGUID AND AGENCYGUID = C_DATA.AGENCYGUID
     AND EXPECOGUID = C_DATA.EXPECOGUID AND FUNDSOURCEGUID = C_DATA.FUNDSOURCEGUID AND SFJZ = '1' AND ISWRITEOFF = '0';

     UPDATE BGT_T_YSJZSJB SET ISWRITEOFF = '1'
     WHERE FINYEAR = C_DATA.FINYEAR AND PROGUID = C_DATA.PROGUID AND AGENCYGUID = C_DATA.AGENCYGUID
     AND EXPECOGUID = C_DATA.EXPECOGUID AND FUNDSOURCEGUID = C_DATA.FUNDSOURCEGUID AND SFJZ = '1' AND ISWRITEOFF = '0';

     INSERT INTO BGT_T_YSJZSJB(FINYEAR,AGENCYGUID,PROGUID,AGENCYEXPGUID,EXPFUNCGUID,FUNDTYPEGUID,EXPECOGUID,FUNDSOURCEGUID,AMT,DATAKEY,BGTTYPEGUID,SAFUNDSGUID,WH,FININTORGGUID,SJZYZFXM)
  SELECT Y.FINYEAR,Y.AGENCYID AGENCYGUID,Y.SPFID PROGUID,'01687gDiFwDjc' AGENCYEXPGUID, EXPFUNCGUID,'01687E2hS1Edv' FUNDTYPEGUID,Y.EXPECOGUID,Y.FUNDSOURCEGUID,Y.AMT}'||' * '||V_EXP||Q'{ AMT,Y.DATAKEY,'01687wARQ1YgH' BGTTYPEGUID
  ,(SELECT ZHUANH FROM BGT_T_YSLYWHB WHERE SUPERID = Y.DATAKEY AND YSLY = Y.FUNDSOURCEGUID AND ROWNUM < 2) SAFUNDSGUID
  ,(SELECT LYWH FROM BGT_T_YSLYWHB WHERE SUPERID = Y.DATAKEY AND YSLY = Y.FUNDSOURCEGUID AND ROWNUM < 2) WH
  ,NVL((SELECT DEPTID FROM SPF_V_FBASEINFO_A WHERE SPFID = Y.SPFID),
           (SELECT FININTORG FROM CODE_T_AGENCY_SPF WHERE GUID = Y.AGENCYID)) FININTORGGUID
  ,SJZYZFXM
  FROM (
  SELECT FINYEAR,DATAKEY,AGENCYID, EXPECOID EXPECOGUID, FUNDSOURCEGUID, AMT,DBVERSION,EXPFUNCID EXPFUNCGUID,SPFID,SJZYZFXM  FROM (
  SELECT * FROM }'||V_TABLE|| ' TA
  WHERE (EXPECOID IS NOT NULL OR EXPFUNCID IS NOT NULL) AND PROJECTID = ''*'' AND SPFID IN (SELECT TASKID FROM SPF_T_OARELATION WHERE DOCID = '''||P_WHERE||''' AND TASKTYPE = ''0'') ) TT
   UNPIVOT(AMT FOR FUNDSOURCEGUID IN('||V_TMP||'))) Y
   WHERE Y.FINYEAR = C_DATA.FINYEAR AND Y.SPFID = C_DATA.PROGUID AND Y.AGENCYID = C_DATA.AGENCYGUID
     AND Y.EXPECOGUID = C_DATA.EXPECOGUID AND Y.FUNDSOURCEGUID = C_DATA.FUNDSOURCEGUID;

  END LOOP;
END;';
    BEGIN
      EXECUTE IMMEDIATE V_SQL;
    EXCEPTION WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      RAISE;
    END;

    --不存在的数据插入
    V_SQL := Q'{INSERT INTO BGT_T_YSJZSJB(FINYEAR,AGENCYGUID,PROGUID,AGENCYEXPGUID,EXPFUNCGUID,FUNDTYPEGUID,EXPECOGUID,FUNDSOURCEGUID,AMT,DATAKEY,BGTTYPEGUID,SAFUNDSGUID,WH,FININTORGGUID,SJZYZFXM)
SELECT Y.FINYEAR,Y.AGENCYID AGENCYGUID,Y.SPFID PROGUID,'01687gDiFwDjc' AGENCYEXPGUID, EXPFUNCGUID,'01687E2hS1Edv' FUNDTYPEGUID,Y.EXPECOGUID,Y.FUNDSOURCEGUID,Y.AMT}'||' * '||V_EXP||Q'{ AMT,Y.DATAKEY,'01687wARQ1YgH' BGTTYPEGUID
,(SELECT ZHUANH FROM BGT_T_YSLYWHB WHERE SUPERID = Y.DATAKEY AND YSLY = Y.FUNDSOURCEGUID AND ROWNUM < 2) SAFUNDSGUID
,(SELECT LYWH FROM BGT_T_YSLYWHB WHERE SUPERID = Y.DATAKEY AND YSLY = Y.FUNDSOURCEGUID AND ROWNUM < 2) WH
,NVL((SELECT DEPTID FROM SPF_V_FBASEINFO_A WHERE SPFID = Y.SPFID),
           (SELECT FININTORG FROM CODE_T_AGENCY_SPF WHERE GUID = Y.AGENCYID)) FININTORGGUID
,SJZYZFXM
FROM (
SELECT FINYEAR,DATAKEY,AGENCYID,EXPECOID EXPECOGUID, FUNDSOURCEGUID, AMT,DBVERSION,EXPFUNCID EXPFUNCGUID,SPFID,SJZYZFXM  FROM (
SELECT * FROM }'||V_TABLE|| ' TA
WHERE (EXPECOID IS NOT NULL OR EXPFUNCID IS NOT NULL) AND PROJECTID = ''*'' AND SPFID IN (SELECT TASKID FROM SPF_T_OARELATION WHERE DOCID = '''||P_WHERE||''' AND TASKTYPE = ''0'') ) TT
 UNPIVOT(AMT FOR FUNDSOURCEGUID IN('||V_TMP||Q'{))) Y
 WHERE NOT EXISTS(SELECT 1 FROM BGT_T_YSJZSJB
 WHERE FINYEAR = Y.FINYEAR AND PROGUID = Y.SPFID AND AGENCYGUID = Y.AGENCYID AND EXPECOGUID = Y.EXPECOGUID AND FUNDSOURCEGUID = Y.FUNDSOURCEGUID)
 }';
    BEGIN
      EXECUTE IMMEDIATE V_SQL;
    EXCEPTION WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      RAISE;
    END;
    
    RETURN;
  END SYS_P_KEEP_ACCOUNTS;
--SYS_P_KEEP_ACCOUNTS