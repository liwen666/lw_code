DECLARE
   --定义变量
   V_COL INT; 

BEGIN
  --查询表是否存在
  SELECT COUNT(*) INTO V_COL   FROM USER_TABLES WHERE TABLE_NAME ='P#SPF_T_P_CONTRACT';
  
  IF V_COL=0 THEN
    --创建合同管理表
    EXECUTE IMMEDIATE Q'{
      create table P#SPF_T_P_CONTRACT
      (
        province               VARCHAR2(9) not null,
        year                   CHAR(4) not null,
        status                 CHAR(1) default '1' not null,
        dbversion              TIMESTAMP(6) default SYSDATE,
        datakey                VARCHAR2(32) default sys_guid() not null,
        orderid                NUMBER(9) default 0,
        needupdate             VARCHAR2(4000),
        projectid              VARCHAR2(32),
        contract_name          VARCHAR2(32),
        contract_code          VARCHAR2(60),
        contract_type          VARCHAR2(32),
        payee_account          VARCHAR2(32),
        payee_name             VARCHAR2(16),
        contract_payment_ratio NUMBER(8) default 0,
        settlement_ratio       NUMBER(8) default 0,
        remark                 VARCHAR2(2000)
      )
    }';
    
    --创建主外键
    EXECUTE IMMEDIATE Q'{
      alter table P#SPF_T_P_CONTRACT
        add constraint PK_P#SPF_T_P_CONTRACT primary key (PROVINCE, YEAR, STATUS, DATAKEY)
    }';
      
    sys_p_partition_table('P#SPF_T_P_CONTRACT');
    
    --创建触发器
    EXECUTE IMMEDIATE Q'{
      CREATE OR REPLACE TRIGGER TR_P#SPF_T_P_CONTRACT
      BEFORE INSERT OR UPDATE ON  P#SPF_T_P_CONTRACT FOR EACH ROW
      BEGIN
        IF INSERTING THEN
          :NEW.PROVINCE:=NVL(:NEW.PROVINCE,GLOBAL_MULTYEAR_CZ.V_PMDIVID);
          :NEW.YEAR:=NVL(:NEW.YEAR,GLOBAL_MULTYEAR_CZ.V_PMYEAR);
          :NEW.DBVERSION := CASE WHEN TO_CHAR(:NEW.DBVERSION, 'YYYY-MM-DD') = '2012-01-01' THEN TO_DATE('2012-01-01', 'YYYY-MM-DD') ELSE SYSDATE END;
        END IF;
        IF (TO_CHAR(:NEW.DBVERSION,'YYYY-MM-DD') ='2012-01-01' AND ((UPDATING AND UPDATING('DBVERSION')) OR INSERTING ) ) THEN
          RETURN ;
        END IF;
        IF UPDATING THEN
          :NEW.DBVERSION:=SYSDATE;
        END IF;
      END TR_P#SPF_T_P_CONTRACT;
    }';
    
    --删除合同管理model
    DELETE FROM dict_t_model where tableid ='F7097096422CDF47E040A8C020035309';
    --删除合同管理表字段
    DELETE FROM dict_t_factor where tableid ='F7097096422CDF47E040A8C020035309';
    
    --添加合同管理model
    insert into dict_t_model (APPID, BGTLVL, DBTABLENAME, DEALTYPE, EXTPROP, INPUTLVL, ISADD, ISMAN, ISPARTITION, ISRESERVED, ISSHOW, ISTASK, ISSUMTAB, MAINUPTAB, NAME, ORDERID, RELATAB, REMARK, SECUSQL, INITSQL, INITSQLTIME, SHORTTITLE, STATUS, SUITID, TABLEID, TABLETYPE, TABSWHERE, ISBAK)
    values ('SPF', '1', 'SPF_T_P_CONTRACT', '5*36', '0000000000000000000000000000000', '1', '0', '0', '1', '0', '1', '0', '0', null, '合同管理', 0, null, null, null, null, null, null, '1', '1470431B25044D2BE050A8C02105302D', 'F7097096422CDF47E040A8C020035309', '1', null, '1');

    --添加合同管理表字段
    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, null, null, null, 'F7097096422DDF47E040A8C020035301', null, 32, 3, 'DATAKEY', 'sys_guid()', null, '00000000000000000000000000000000', null, null, null, null, '0', '0', '1', '1', '1', '0', '0', '0', '0', '0', '0', 1, '合同ID', '0', 1, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7097096422EDF47E040A8C020035302', null, 9, 1, 'ORDERID', '0', null, null, null, null, null, null, '0', '0', '1', '0', '1', '0', '1', '0', '0', '0', '0', 1, '排序标志', '1', 2, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7097096422FDF47E040A8C020035303', null, 4000, 3, 'NEEDUPDATE', null, null, null, null, null, null, null, '0', '0', '1', '0', '1', '0', '1', '0', '0', '0', '0', 1, '刷新标志', '1', 3, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, null, null, null, 'F7099198E0749B06E040A8C020035519', null, 32, 3, 'PROJECTID', null, null, '0000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '项目ID', '0', 4, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E0759B06E040A8C020035519', null, 32, 3, 'CONTRACT_NAME', null, null, '00000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '合同名称', '0', 5, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E0769B06E040A8C020035519', null, 60, 3, 'CONTRACT_CODE',  null, null, '0000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '合同编号', '1', 6, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E0779B06E040A8C020035519', 'FAE59D044AB671A5E040A8C02105223C', 32, 6, 'CONTRACT_TYPE', null, null, '00000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '合同分类', '1', 7, null, null, 0, '4', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E07B9B06E040A8C020035519', null, 32, 3, 'PAYEE_ACCOUNT', null, null, '0000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '收款账户号', '1', 11, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E07C9B06E040A8C020035519', null, 16, 3, 'PAYEE_NAME', null, null, '0000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '收款账户名称', '1', 12, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E07D9B06E040A8C020035519', null, 8, 1, 'CONTRACT_PAYMENT_RATIO', '0', null, '00000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '合同支付比例', '1', 13, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E07F9B06E040A8C020035519', null, 8, 1, 'SETTLEMENT_RATIO', '0', null, '00000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '合同工程结算比例', '1', 14, null, null, 0, '0', 0, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    insert into dict_t_factor (ALIAS, BANDCOLUMNID, BANDREFDWCOL, BGTLVL, COLFORMAT, COLTIPS, COLUMNID, CSID, DATALENGTH, DATATYPE, DBCOLUMNNAME,  DEFAULTVALUE, DEID, EXTPROP, FRMCOLID, FRMTABID, HREFLOC, HREFPARMID, ISBANDCOL, ISHREF, OPENWINDOWTYPE, ISKEY, ISLEAF, ISREGEX, ISRESERVE, ISSUM, ISUPDATE, ISVIRTUAL, ISVISIBLE, LEVELNO, NAME, NULLABLE, ORDERID, REGEXPR, REGEXPRINFO, SCALE, SHOWFORMAT, SHOWWIDTH, STATUS, SUPERID, TABLEID, VIRCONTEXT,  PARENTNODECANCHECK, XLSXCOLUMNID)
    values (null, null, null, '1', null, null, 'F7099198E0809B06E040A8C020035519', null, 2000, 3, 'REMARK', null, null, '00000000000000000000000000000000', null, null, null, null, '0', '0', '1', '0', '1', '0', '0', '0', '1', '0', '1', 1, '备注', '1', 15, null, null, 0, 'A', 100, '1', '0', 'F7097096422CDF47E040A8C020035309', null, '0', null);

    --公用方法，刷合同管理视图
    sys_p_recreate_views('F7097096422CDF47E040A8C020035309');
  END IF;
END;
--SPF_T_P_CONTRACT(合同管理)
